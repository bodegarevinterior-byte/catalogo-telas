<script>
  // Guardamos las muestras escaneadas en localStorage
  let carrito = JSON.parse(localStorage.getItem('carrito')) || [];

  function agregarMuestra(id) {
    if (!carrito.includes(id)) {
      carrito.push(id);
      localStorage.setItem('carrito', JSON.stringify(carrito));
    }
    renderFormulario();
  }

  function renderFormulario() {
    const cont = document.getElementById('formulario');
    if (!cont) return;

    if (carrito.length === 0) {
      cont.innerHTML = "<p>No hay muestras seleccionadas.</p>";
      return;
    }

    // Armamos listado
    let listado = carrito.map(m => `<li>${m}</li>`).join("");

    cont.innerHTML = `
      <h2>Registrar salida</h2>
      <ul>${listado}</ul>
      <form id="salidaForm" action="https://formspree.io/f/mjkegwag" method="POST">
        <label>Prestado a:</label>
        <input type="text" name="cliente" required>
        <label>Correo del cliente:</label>
        <input type="email" name="correo" required>
        <input type="hidden" name="muestras" value="${carrito.join(", ")}">
        <button type="submit">Registrar salida</button>
      </form>
      <button onclick="agregarOtra()">‚ûï Agregar muestra</button>
    `;
    
    // Manejo del env√≠o
    document.getElementById('salidaForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const form = e.target;

      // Adjuntamos la fecha autom√°ticamente
      const dateInput = document.createElement('input');
      dateInput.type = 'hidden';
      dateInput.name = 'fecha';
      dateInput.value = new Date().toLocaleString();
      form.appendChild(dateInput);

      // Enviamos
      fetch(form.action, {
        method: form.method,
        body: new FormData(form),
        headers: { 'Accept': 'application/json' }
      }).then(() => {
        alert("Salida registrada con √©xito ‚úÖ");
        localStorage.removeItem('carrito');  // limpiar
        window.location.href = "index.html"; // volver limpio
      }).catch(() => {
        alert("Error al registrar la salida ‚ùå");
      });
    });
  }

  function agregarOtra() {
    alert("Escanea otra muestra para agregarla üì∑");
  }

  // --- Al cargar p√°gina ---
  const params = new URLSearchParams(window.location.search);
  const singleId = params.get('id');
  if (singleId) {
    agregarMuestra(singleId);
  } else {
    renderFormulario();
  }
</script>
