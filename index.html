<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cat√°logo de Telas</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background:#f4f4f4; }
    header { background:#222; color:#fff; padding:16px; text-align:center; }
    #controls { padding:12px; background:#fff; text-align:center; }
    .btn { padding:10px 14px; margin:4px; border:none; border-radius:6px; cursor:pointer; background:#1f6feb; color:#fff; }
    .btn:hover { background:#1756b8; }
    #resultados { display:grid; gap:12px; padding:12px; }
    .card { background:#fff; padding:10px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,.1); }
    .thumb { width:100%; height:150px; object-fit:cover; background:#eee; border-radius:6px; }

    #panel-form { display:none; padding:12px; max-width:800px; margin:20px auto; background:#fff; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,.1); }
    #panel-form h2 { margin-top:0; }
    input, textarea { padding:8px; width:100%; margin:6px 0; border:1px solid #ccc; border-radius:6px; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #ddd; padding:6px; font-size:14px; }
    th { background:#f0f0f0; }
    .modal { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; }
    .modal .box { background:#fff; padding:14px; border-radius:8px; }
  </style>
</head>
<body>
  <header><h1>Cat√°logo de Telas</h1></header>

  <div id="controls">
    <input id="buscador" type="text" placeholder="Buscar..." />
    <button class="btn" id="btnForm">Crear formulario de pr√©stamo</button>
  </div>

  <div id="resultados"></div>

  <section id="panel-form">
    <h2>Formulario de pr√©stamo</h2>
    <form id="formPrestamo" action="https://formspree.io/f/mjkegwag" method="POST">
      <input type="text" name="cliente" placeholder="Nombre del cliente" required>
      <input type="email" name="correo" placeholder="Correo del cliente" required>

      <h3>Muestras</h3>
      <input type="text" id="manualId" placeholder="Escribir ID manual (ej. MUESTRA-001)">
      <button type="button" class="btn" id="btnAddManual">Agregar manual</button>
      <button type="button" class="btn" id="btnScan">üì∑ Escanear QR</button>

      <table id="tablaMuestras">
        <thead>
          <tr>
            <th>#</th><th>ID</th><th>Descripci√≥n</th><th>Proveedor</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <textarea name="muestras" id="muestrasHidden" hidden></textarea>

      <button type="submit" class="btn">Enviar</button>
    </form>
  </section>

  <!-- Modal scanner -->
  <div class="modal" id="modalScan">
    <div class="box">
      <h3>Escanear QR</h3>
      <div id="qr-reader" style="width:300px"></div>
      <button class="btn" id="btnCerrarScan">Cerrar</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script>
    const CSV_URL = './datos.csv';
    const TINYURL_API_KEY = "OZCnascicZRsKxEcbx8GLyIwdwnZ5H7UtfzaZxGufk5Uvbwre3JxnlIMezLJ";

    const resultados = document.getElementById('resultados');
    const buscador = document.getElementById('buscador');
    const btnForm = document.getElementById('btnForm');
    const panelForm = document.getElementById('panel-form');
    const tablaBody = document.querySelector('#tablaMuestras tbody');
    const muestrasHidden = document.getElementById('muestrasHidden');

    let datos = [];
    let carrito = [];

    // Render cat√°logo
    function render(lista){
      resultados.innerHTML = '';
      lista.forEach(item=>{
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <img class="thumb" src="${item.IMAGEN}" alt="${item.DESCRIPCION}">
          <h4>${item.DESCRIPCION}</h4>
          <p><b>ID:</b> ${item.ID}</p>
          <p><b>Proveedor:</b> ${item.PROVEEDOR}</p>
        `;
        resultados.appendChild(div);
      });
    }

    buscador.addEventListener('input', ()=>{
      const t = buscador.value.toLowerCase();
      render(datos.filter(it=>
        (it.ID||'').toLowerCase().includes(t) ||
        (it.DESCRIPCION||'').toLowerCase().includes(t)
      ));
    });

    // Mostrar formulario
    btnForm.addEventListener('click', ()=>{
      panelForm.style.display = 'block';
      window.scrollTo({ top: panelForm.offsetTop, behavior:'smooth' });
    });

    // Carrito
    function addMuestra(id){
      const up = id.toUpperCase();
      if (carrito.includes(up)) return;
      const item = datos.find(d=> (d.ID||'').toUpperCase()===up);
      if (!item) { alert('ID no encontrado en cat√°logo'); return; }
      carrito.push(up);
      renderTabla();
    }

    function removeMuestra(id){
      carrito = carrito.filter(x=>x!==id);
      renderTabla();
    }

    function renderTabla(){
      tablaBody.innerHTML = '';
      carrito.forEach((id, idx)=>{
        const it = datos.find(d=> (d.ID||'').toUpperCase()===id);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx+1}</td><td>${id}</td><td>${it?.DESCRIPCION||''}</td><td>${it?.PROVEEDOR||''}</td>
          <td><button type="button" onclick="removeMuestra('${id}')">Quitar</button></td>
        `;
        tablaBody.appendChild(tr);
      });
      muestrasHidden.value = carrito.join('\n');
    }
    window.removeMuestra = removeMuestra; // para onclick

    document.getElementById('btnAddManual').addEventListener('click', ()=>{
      const val = document.getElementById('manualId').value.trim();
      if (val) addMuestra(val);
    });

    // QR
    let html5QrCode;
    document.getElementById('btnScan').addEventListener('click', async()=>{
      document.getElementById('modalScan').style.display='flex';
      if (!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader");
      await html5QrCode.start({ facingMode:"environment" }, { fps:10, qrbox:250 }, async(text)=>{
        try {
          let id = await expandAndExtractID(text);
          if (id) addMuestra(id);
        } catch(e){ console.error(e); alert('Error procesando QR'); }
      });
    });

    document.getElementById('btnCerrarScan').addEventListener('click', async()=>{
      if (html5QrCode) await html5QrCode.stop();
      document.getElementById('modalScan').style.display='none';
    });

    async function expandAndExtractID(url){
      if (!/^https?:\/\//i.test(url)) return url;
      // expandir TinyURL
      if (/tinyurl\.com/i.test(url)){
        const r = await fetch('https://api.tinyurl.com/expand', {
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'Authorization': `Bearer ${TINYURL_API_KEY}`
          },
          body: JSON.stringify({ url })
        });
        const j = await r.json();
        if (j?.data?.long_url) url = j.data.long_url;
      }
      try {
        const u = new URL(url);
        return u.searchParams.get('id');
      } catch { return null; }
    }

    // Cargar CSV
    Papa.parse(CSV_URL, {
      download:true, header:true, complete: res=>{
        datos = res.data.filter(r=>r.ID);
        render(datos);
      }
    });
  </script>
</body>
</html>
