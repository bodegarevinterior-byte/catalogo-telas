<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulario de Préstamo</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; background:#f4f4f4; margin:0; padding:20px; }
    .box { max-width: 800px; margin: auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,.1); }
    h1 { margin-top:0; }
    input, button { padding:10px; margin:6px 0; font-size:15px; }
    input { width:100%; border:1px solid #ccc; border-radius:8px; }
    button { border:none; border-radius:8px; font-weight:600; cursor:pointer; color:#fff; background:#1f6feb; }
    button:hover { background:#1756b8; }
    table { width:100%; border-collapse: collapse; margin-top:12px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:left; }
    .actions { margin-top:14px; display:flex; gap:10px; }
  </style>
</head>
<body>
  <div class="box">
    <h1>Registro de Préstamo</h1>
    <form id="formPrestamo" action="https://formspree.io/f/mjkegwag" method="POST">
      <label>Cliente:</label>
      <input type="text" name="cliente" id="cliente" required>
      <label>Correo:</label>
      <input type="email" name="correo" id="correo" required>

      <label>ID de muestra:</label>
      <input type="text" id="inputMuestra" placeholder="Ejemplo: MUESTRA-001">
      <button type="button" id="btnAgregar">Agregar muestra</button>

      <table id="tablaMuestras">
        <thead>
          <tr>
            <th>#</th>
            <th>ID</th>
            <th>Descripción</th>
            <th>Proveedor</th>
            <th>Código</th>
            <th>Ubicación</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <input type="hidden" name="muestras" id="muestrasHidden">

      <div class="actions">
        <button type="submit">Enviar</button>
        <a href="index.html" style="background:#666; padding:10px 14px; border-radius:8px; color:#fff; text-decoration:none;">⬅ Volver al catálogo</a>
      </div>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const CSV_URL = './datos.csv';
    let datos = [];
    let carrito = [];

    const tablaBody = document.querySelector('#tablaMuestras tbody');
    const inputMuestra = document.getElementById('inputMuestra');
    const btnAgregar = document.getElementById('btnAgregar');
    const muestrasHidden = document.getElementById('muestrasHidden');
    const formPrestamo = document.getElementById('formPrestamo');

    Papa.parse(CSV_URL, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(res){
        datos = res.data || [];
      }
    });

    function renderTabla(){
      tablaBody.innerHTML = '';
      carrito.forEach((id, idx)=>{
        const it = datos.find(d => (d['ID']||'').toUpperCase() === id);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${id}</td>
          <td>${it?.['DESCRIPCION']||''}</td>
          <td>${it?.['PROVEEDOR']||''}</td>
          <td>${it?.['CODIGO']||''}</td>
          <td>${it?.['UBICACION']||''}</td>
          <td><button type="button" onclick="removeMuestra('${id}')">Quitar</button></td>
        `;
        tablaBody.appendChild(tr);
      });
      muestrasHidden.value = carrito.map(id=>{
        const it = datos.find(d => (d['ID']||'').toUpperCase() === id);
        return `ID:${id} | Desc:${it?.['DESCRIPCION']||''} | Prov:${it?.['PROVEEDOR']||''} | Cod:${it?.['CODIGO']||''} | Ubic:${it?.['UBICACION']||''}`;
      }).join('\n');
    }

    function removeMuestra(id){
      carrito = carrito.filter(x=>x!==id);
      renderTabla();
    }

    btnAgregar.addEventListener('click', ()=>{
      const val = (inputMuestra.value||'').trim().toUpperCase();
      if (!val) return;
      const existe = datos.find(d => (d['ID']||'').toUpperCase() === val);
      if (!existe){ alert('No existe esa muestra en el catálogo'); return; }
      if (!carrito.includes(val)) carrito.push(val);
      inputMuestra.value = '';
      renderTabla();
    });

    formPrestamo.addEventListener('submit', ()=>{
      const hiddenFecha = document.createElement('input');
      hiddenFecha.type = 'hidden';
      hiddenFecha.name = 'fecha';
      hiddenFecha.value = new Date().toLocaleString();
      formPrestamo.appendChild(hiddenFecha);
    });
  </script>
</body>
</html>
